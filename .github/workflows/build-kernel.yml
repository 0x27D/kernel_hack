name: Build Kernel Modules

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-modules:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          linux-headers-generic \
          libelf-dev \
          git
    
    - name: Check repository structure
      run: |
        echo "Repository contents:"
        ls -la
        echo "Makefile content:"
        if [ -f "Makefile" ]; then
          cat Makefile
        fi
    
    - name: Build kernel modules
      run: |
        # Build các module nếu có Makefile
        if [ -f "Makefile" ]; then
          make
          find . -name "*.ko" -type f | while read module; do
            echo "Built module: $module"
            file "$module"
          done
        else
          echo "No Makefile found, checking for individual modules..."
          # Tìm và build các module riêng lẻ
          find . -name "Makefile" -type f | while read makefile; do
            dir=$(dirname "$makefile")
            echo "Building in $dir"
            (cd "$dir" && make) || echo "Build failed in $dir"
          done
        fi
    
    - name: List built artifacts
      run: |
        find . -name "*.ko" -o -name "*.o" | while read file; do
          echo "Artifact: $file"
          file "$file" || true
        done
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel-modules
        path: |
          **/*.ko
          **/*.o
        retention-days: 7
